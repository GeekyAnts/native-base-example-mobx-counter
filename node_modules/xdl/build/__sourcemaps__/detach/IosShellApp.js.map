{"version":3,"sources":["detach/IosShellApp.js"],"names":["async","args","iosDir","privateConfigFile","spawnAsyncThrowError","path","join","configureShellAppSecretsAsync","configFilePath","manifest","privateConfig","bundleIdentifier","let","result","await","modifyIOSPropertyListAsync","config","ios","infoPlist","extraConfig","key","hasOwnProperty","CFBundleIdentifier","Error","CFBundleName","name","linkingSchemes","scheme","facebookScheme","startsWith","push","googleSignIn","reservedClientId","CFBundleURLTypes","CFBundleURLSchemes","CFBundleURLName","usesNonExemptEncryption","ITSAppUsesNonExemptEncryption","googleMapsApiKey","GMSApiKey","EXClientVersion","CFBundleVersion","version","buildNumber","CFBundleShortVersionString","Fabric","APIKey","fabric","apiKey","DEFAULT_FABRIC_KEY","Kits","KitInfo","KitName","permissionsAppName","indexOf","replace","UIDeviceFamily","supportsTablet","configureStandaloneIOSInfoPlistAsync","manifestUrl","shellConfig","isShell","permissions","isDetached","isManifestVerificationBypassed","isRemoteJSEnabled","console","log","configureStandaloneIOSShellPlistAsync","validateConfigArguments","privateConfigContents","fs","promise","readFile","JSON","parse","url","UILaunchStoryboardName","configurePropertyListsAsync","bundleUrl","writeFile","stringify","saveUrlToPathAsync","preloadManifestAndBundleAsync","restoreOriginals","cleanIOSPropertyListBackupAsync","cleanPropertyListBackupsAsync","iOSRootPath","relativeBuildDestination","action","configuration","verbose","type","buildCmd","buildDest","pathToApp","stdio","cwd","shell","artifactLocation","buildAsync","validateArgs","sdkVersion","output","getManifestAsync","archivePath","configureIOSIconsAsync","archiveName","spawnAsync","createIOSShellAppAsync","cmdArgs","bundleIdentifierFromManifest","warn"],"mappings":"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","file":"../../detach/IosShellApp.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n\n'use strict';\n\nimport 'instapromise';\n\nimport fs from 'fs';\nimport path from 'path';\nimport {\n  getManifestAsync,\n  saveUrlToPathAsync,\n  spawnAsync,\n  spawnAsyncThrowError,\n  modifyIOSPropertyListAsync,\n  cleanIOSPropertyListBackupAsync,\n  configureIOSIconsAsync,\n} from './ExponentTools';\n\n// TODO: move this somewhere else. this is duplicated in universe/exponent/template-files/keys,\n// but xdl doesn't have access to that.\nconst DEFAULT_FABRIC_KEY = '81130e95ea13cd7ed9a4f455e96214902c721c99';\n\nfunction validateConfigArguments(manifest, cmdArgs, configFilePath) {\n  if (!configFilePath) {\n    throw new Error('No path to config files provided');\n  }\n  let bundleIdentifierFromManifest = (manifest.ios) ? manifest.ios.bundleIdentifier : null;\n  if (!bundleIdentifierFromManifest && !cmdArgs.bundleIdentifier) {\n    throw new Error('No bundle identifier found in either the manifest or argv');\n  }\n  if (!manifest.name) {\n    throw new Error('Manifest does not have a name');\n  }\n\n  if (!cmdArgs.privateConfigFile) {\n    console.warn('Warning: No config file specified.');\n  }\n  return true;\n}\n\n/**\n * Writes Fabric config to private-shell-app-config.json if necessary. Used by\n * generate-dynamic-macros when building.\n */\nasync function configureShellAppSecretsAsync(args, iosDir) {\n  if (!args.privateConfigFile) {\n    return;\n  }\n\n  spawnAsyncThrowError('/bin/cp', [args.privateConfigFile, path.join(iosDir, 'private-shell-app-config.json')]);\n}\n\n/**\n * Configure an iOS Info.plist for a standalone app given its exponent configuration.\n * @param configFilePath Path to Info.plist\n * @param manifest the app's manifest\n * @param privateConfig optional config with the app's private keys\n * @param bundleIdentifier optional bundle id if the manifest doesn't contain one already\n */\nasync function configureStandaloneIOSInfoPlistAsync(configFilePath, manifest, privateConfig = null, bundleIdentifier = null) {\n  let result = await modifyIOSPropertyListAsync(configFilePath, 'Info', (config) => {\n\n    // make sure this happens first:\n    // apply any custom information from ios.infoPlist prior to all other exponent config\n    if (manifest.ios && manifest.ios.infoPlist) {\n      let extraConfig = manifest.ios.infoPlist;\n      for (let key in extraConfig) {\n        if (extraConfig.hasOwnProperty(key)) {\n          config[key] = extraConfig[key];\n        }\n      }\n    }\n\n    // bundle id\n    config.CFBundleIdentifier = (manifest.ios && manifest.ios.bundleIdentifier) ? manifest.ios.bundleIdentifier : bundleIdentifier;\n    if (!config.CFBundleIdentifier) {\n      throw new Error(`Cannot configure an iOS app with no bundle identifier.`);\n    }\n\n    // app name\n    config.CFBundleName = manifest.name;\n\n    // determine app linking schemes\n    let linkingSchemes = (manifest.scheme) ? [manifest.scheme] : [];\n    if (manifest.facebookScheme && manifest.facebookScheme.startsWith('fb')) {\n      linkingSchemes.push(manifest.facebookScheme);\n    }\n    if (privateConfig && privateConfig.googleSignIn &&\n        privateConfig.googleSignIn.reservedClientId) {\n      linkingSchemes.push(privateConfig.googleSignIn.reservedClientId);\n    }\n\n    // remove exp scheme, add app scheme(s)\n    config.CFBundleURLTypes = [{\n      CFBundleURLSchemes: linkingSchemes,\n    }, {\n      // Add the generic oauth redirect, it's important that it has the name\n      // 'OAuthRedirect' so we can find it in app code.\n      CFBundleURLName: 'OAuthRedirect',\n      CFBundleURLSchemes: [config.CFBundleIdentifier],\n    }];\n\n    // set ITSAppUsesNonExemptEncryption to let people skip manually\n    // entering it in iTunes Connect\n    if (privateConfig &&\n        privateConfig.hasOwnProperty('usesNonExemptEncryption') &&\n        privateConfig.usesNonExemptEncryption === false) {\n      config.ITSAppUsesNonExemptEncryption = false;\n    }\n\n    // google maps api key\n    if (privateConfig && privateConfig.googleMapsApiKey) {\n      config.GMSApiKey = privateConfig.googleMapsApiKey;\n    }\n\n    // permanently save the exponent client version at time of configuration\n    config.EXClientVersion = config.CFBundleVersion;\n\n    // use version from manifest\n    let version = (manifest.version) ? manifest.version : '0.0.0';\n    let buildNumber = (manifest.ios && manifest.ios.buildNumber) ?\n      manifest.ios.buildNumber :\n      '1';\n    config.CFBundleShortVersionString = version;\n    config.CFBundleVersion = buildNumber;\n\n    config.Fabric = {\n      APIKey: (privateConfig && privateConfig.fabric && privateConfig.fabric.apiKey) || DEFAULT_FABRIC_KEY,\n      Kits: [{\n        KitInfo: {},\n        KitName: 'Crashlytics',\n      }],\n    };\n\n    let permissionsAppName = (manifest.name) ? manifest.name : 'this app';\n    for (let key in config) {\n      if (config.hasOwnProperty(key) && key.indexOf('UsageDescription') !== -1) {\n        config[key] = config[key].replace('Expo experiences', permissionsAppName);\n      }\n    }\n\n    // 1 is iPhone, 2 is iPad\n    config.UIDeviceFamily = (manifest.ios && manifest.ios.supportsTablet) ? [1, 2] : [1];\n\n    return config;\n  });\n  return result;\n}\n\n/**\n * Configure EXShell.plist for a standalone app given its exponent configuration.\n * @param configFilePath Path to Info.plist\n * @param manifest the app's manifest\n * @param manifestUrl the app's manifest url\n */\nasync function configureStandaloneIOSShellPlistAsync(configFilePath, manifest, manifestUrl) {\n  await modifyIOSPropertyListAsync(configFilePath, 'EXShell', (shellConfig) => {\n    shellConfig.isShell = true;\n    shellConfig.manifestUrl = manifestUrl;\n    if (manifest.ios && manifest.ios.permissions) {\n      shellConfig.permissions = manifest.ios.permissions;\n    }\n    if (manifest.isDetached) {\n      // disable manifest verification on detached apps until\n      // the developer adds the correct entitlements to their bundle id.\n      shellConfig.isManifestVerificationBypassed = true;\n    }\n    if (manifest.ios && manifest.ios.hasOwnProperty('isRemoteJSEnabled')) {\n      // enable/disable code push if the developer provided specific behavior\n      shellConfig.isRemoteJSEnabled = manifest.ios.isRemoteJSEnabled;\n    }\n\n    console.log('Using shell config:', shellConfig);\n    return shellConfig;\n  });\n}\n\nasync function configurePropertyListsAsync(manifest, args, configFilePath) {\n  // make sure we have all the required info\n  validateConfigArguments(manifest, args, configFilePath);\n  console.log(`Modifying config files under ${configFilePath}...`);\n\n  let {\n    privateConfigFile,\n  } = args;\n\n  let privateConfig;\n  if (privateConfigFile) {\n    let privateConfigContents = await fs.promise.readFile(privateConfigFile, 'utf8');\n    privateConfig = JSON.parse(privateConfigContents);\n  }\n\n  // generate new shell config\n  await configureStandaloneIOSShellPlistAsync(configFilePath, manifest, args.url);\n\n  // Info.plist changes specific to turtle\n  await modifyIOSPropertyListAsync(configFilePath, 'Info', (config) => {\n    // use shell-specific launch screen\n    config.UILaunchStoryboardName = 'LaunchScreenShell';\n    return config;\n  });\n\n  // common standalone Info.plist config changes\n  await configureStandaloneIOSInfoPlistAsync(configFilePath, manifest, privateConfig, args.bundleIdentifier);\n}\n\n/**\n * Write the manifest and JS bundle to the iOS NSBundle.\n */\nasync function preloadManifestAndBundleAsync(manifest, args, configFilePath) {\n  let bundleUrl = manifest.bundleUrl;\n  await fs.promise.writeFile(`${configFilePath}/shell-app-manifest.json`, JSON.stringify(manifest));\n  await saveUrlToPathAsync(bundleUrl, `${configFilePath}/shell-app.bundle`);\n  return;\n}\n\nasync function cleanPropertyListBackupsAsync(configFilePath, restoreOriginals) {\n  console.log('Cleaning up...');\n  await cleanIOSPropertyListBackupAsync(configFilePath, 'EXShell', restoreOriginals);\n  await cleanIOSPropertyListBackupAsync(configFilePath, 'Info', restoreOriginals);\n}\n\n/**\n *  Build the iOS binary from source.\n *  @return the path to the resulting .app\n */\nasync function buildAsync(args, iOSRootPath, relativeBuildDestination) {\n  let { action, configuration, verbose, type } = args;\n\n  let buildCmd, buildDest, pathToApp;\n  if (type === 'simulator') {\n    buildDest = `${iOSRootPath}/${relativeBuildDestination}-simulator`;\n    buildCmd = `xcodebuild -workspace Exponent.xcworkspace -scheme Exponent -sdk iphonesimulator -configuration ${configuration} -arch i386 -derivedDataPath ${buildDest} CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO SKIP_INSTALL=NO | xcpretty`;\n    pathToApp = `${buildDest}/Build/Products/${configuration}-iphonesimulator/Exponent.app`;\n  } else if (type === 'archive') {\n    buildDest = `${iOSRootPath}/${relativeBuildDestination}-archive`;\n    buildCmd = `xcodebuild -workspace Exponent.xcworkspace -scheme Exponent archive -configuration ${configuration} -derivedDataPath ${buildDest} -archivePath ${buildDest}/Exponent.xcarchive CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO SKIP_INSTALL=NO | xcpretty`;\n    pathToApp = `${buildDest}/Exponent.xcarchive/Products/Applications/Exponent.app`;\n  }\n\n  if (buildCmd) {\n    console.log(`Building shell app under ${iOSRootPath}/${relativeBuildDestination}`);\n    console.log(`  (action: ${action}, configuration: ${configuration})...`);\n    console.log(buildCmd);\n    await spawnAsyncThrowError(buildCmd, null, {\n      stdio: (\n        (verbose) ?\n        'inherit' :\n        ['ignore', 'ignore', 'inherit'] // only stderr\n      ),\n      cwd: iOSRootPath,\n      shell: true,\n    });\n\n    let artifactLocation = `${iOSRootPath}/../shellAppBase-builds/${type}/${configuration}/`;\n    await spawnAsyncThrowError('/bin/rm', ['-rf', artifactLocation]);\n    await spawnAsyncThrowError('/bin/mkdir', ['-p', artifactLocation]);\n\n    if (type === 'archive') {\n      await spawnAsyncThrowError('/bin/cp', ['-R', `${buildDest}/Exponent.xcarchive`, artifactLocation]);\n    } else if (type === 'simulator') {\n      await spawnAsyncThrowError('/bin/cp', ['-R', pathToApp, artifactLocation]);\n    }\n\n  }\n  return pathToApp;\n}\n\nfunction validateArgs(args) {\n  args.type = args.type || 'archive';\n  args.configuration = args.configuration || 'Release';\n  args.verbose = args.verbose || false;\n\n  switch (args.type) {\n    case 'simulator': {\n      if (args.configuration !== 'Debug' && args.configuration !== 'Release') {\n        throw new Error(`Unsupported build configuration ${args.configuration}`);\n      }\n      break;\n    }\n    case 'archive': {\n      if (args.configuration !== 'Release') {\n        throw new Error('Release is the only supported configuration when archiving');\n      }\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build type ${args.type}`);\n    }\n  }\n\n  switch (args.action) {\n    case 'configure': {\n      if (!args.url) {\n        throw new Error('Must run with `--url MANIFEST_URL`');\n      }\n      if (!args.sdkVersion) {\n        throw new Error('Must run with `--sdkVersion SDK_VERSION`');\n      }\n      if (!args.archivePath) {\n        throw new Error('Need to provide --archivePath <path to existing archive for configuration>');\n      }\n      break;\n    }\n    case 'build': {\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build action ${args.action}`);\n    }\n  }\n\n  return args;\n}\n\n/**\n*  @param url manifest url for shell experience\n*  @param sdkVersion sdk to use when requesting the manifest\n*  @param action\n*    build - build a binary\n*    configure - don't build anything, just configure the files in an existing .app bundle\n*  @param type simulator or archive, for action == build\n*  @param configuration Debug or Release, for type == simulator (default Release)\n*  @param archivePath path to existing bundle, for action == configure\n*  @param privateConfigFile path to a private config file containing, e.g., private api keys\n*  @param bundleIdentifier iOS CFBundleIdentifier to use in the bundle config\n*  @param verbose show all xcodebuild output (default false)\n*/\nasync function createIOSShellAppAsync(args) {\n  let configFilePath;\n  args = validateArgs(args);\n\n  if (args.action !== 'configure') {\n    // build the app before configuring\n    await configureShellAppSecretsAsync(args, '../ios');\n    configFilePath = await buildAsync(args, '../ios', '../shellAppBase');\n  } else {\n    let {\n      url,\n      sdkVersion,\n      output,\n      type,\n    } = args;\n\n    // fetch manifest\n    let manifest = await getManifestAsync(url, {\n      'Exponent-SDK-Version': sdkVersion,\n      'Exponent-Platform': 'ios',\n    });\n\n    // action === 'configure'\n    configFilePath = args.archivePath;\n    // just configure, don't build anything\n    await configurePropertyListsAsync(manifest, args, configFilePath);\n    await configureIOSIconsAsync(manifest, configFilePath);\n    await preloadManifestAndBundleAsync(manifest, args, configFilePath);\n    await cleanPropertyListBackupsAsync(configFilePath, false);\n\n    let archiveName = manifest.name.replace(/\\s+/g, '');\n    if (type === 'simulator') {\n      await spawnAsync(`mv Exponent.app ${archiveName}.app && tar cvf ${output} ${archiveName}.app`, null, {\n        stdio: 'inherit',\n        cwd: `${configFilePath}/..`,\n        shell: true,\n      });\n    } else if (type === 'archive') {\n      await spawnAsync('/bin/mv', ['Exponent.xcarchive', output], {\n        stdio: 'inherit',\n        cwd: `${configFilePath}/../../../..`,\n      });\n    }\n  }\n\n  return;\n}\n\nexport {\n  createIOSShellAppAsync,\n  configureStandaloneIOSInfoPlistAsync,\n  configureStandaloneIOSShellPlistAsync,\n};\n"],"sourceRoot":"/xdl/src"}